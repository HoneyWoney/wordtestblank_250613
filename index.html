<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ëŒ€í™”ë¬¸ ì™„ì„±í•˜ê¸° ì˜ë‹¨ì–´ í€´ì¦ˆê²Œì„</title>
<style>
  body {
    font-family: 'Comic Sans MS', cursive, sans-serif;
    background: #fff0f5;
    margin: 0; padding: 0;
    display: flex; flex-direction: column;
    align-items: center;
    min-height: 100vh;
  }
  h1 {
    color: #d6336c;
    margin-top: 20px;
    font-size: 2.2rem;
  }
  #nameInputSection, #previewSection, #quizSection, #resultSection {
    background: #fff;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(214,51,108,0.4);
    padding: 20px 30px;
    margin: 20px;
    max-width: 720px;
    width: 90%;
  }
  label, input[type="text"] {
    font-size: 1.2rem;
  }
  input[type="text"], input.blankInput {
    font-family: 'Comic Sans MS', cursive, sans-serif;
    font-size: 1.1rem;
    width: auto;
    min-width: 50px;
    padding: 3px 6px;
    border: 2px solid #d6336c;
    border-radius: 6px;
    text-align: center;
    margin: 0 3px;
    vertical-align: middle;
  }
  input.blankInput.correct {
    border-color: #2e7d32;
    background-color: #d0f0c0;
    font-weight: bold;
  }
  input.blankInput.incorrect {
    border-color: #d32f2f;
    background-color: #f9d6d5;
  }
  .correctAnswer {
    font-size: 0.9rem;
    color: #2e7d32;
    margin-left: 8px;
    vertical-align: middle;
    font-weight: 700;
  }
  button {
    margin-top: 20px;
    background-color: #ff7f9f;
    color: white;
    border: none;
    border-radius: 15px;
    padding: 12px 24px;
    font-size: 1.2rem;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(214,51,108,0.5);
    transition: background-color 0.3s ease;
  }
  button:hover:not(:disabled) {
    background-color: #d6336c;
  }
  button:disabled {
    background-color: #ffcad4;
    cursor: default;
  }
  #sentence {
    font-size: 1.3rem;
    margin-bottom: 10px;
    color: #5c1030;
    white-space: pre-wrap;
    line-height: 1.6em;
  }
  #meaning {
    color: #9d466c;
    margin-bottom: 18px;
    font-size: 1.3rem; /* ë¬¸ì œì™€ ê°™ì€ í¬ê¸° */
    white-space: pre-wrap;
    line-height: 1.6em;
  }
  #feedback {
    font-weight: bold;
    font-size: 1.25rem;
    margin-top: 10px;
    min-height: 32px;
  }
  #progress {
    font-size: 1rem;
    color: #8a2a5b;
    margin-top: 6px;
  }
  #scoreDisplay {
    font-size: 1.4rem;
    color: #d6336c;
    font-weight: 700;
  }
  #response {
    margin-top: 10px;
    color: #3d185b;
    white-space: pre-wrap;
    font-family: monospace;
    font-size: 0.9rem;
  }
  #previewContainer {
    max-height: 400px;
    overflow-y: auto;
    background: #fff0f5cc;
    padding: 15px;
    border-radius: 12px;
    border: 2px dashed #d6336c;
  }
  .paragraph {
    margin-bottom: 25px;
  }
  .engLine {
    white-space: nowrap;
    margin-bottom: 0; /* ê°„ê²© ì—†ì•° */
  }
  .engSpeaker {
    font-weight: 700;
    color: #5c1030;
    margin-right: 6px;
  }
  .engText {
    color: #5c1030;
  }
  .korLine {
    color: #9d466c;
    margin-left: 24px;
    margin-bottom: 4px;
    white-space: pre-wrap;
  }
</style>
</head>
<body>
<h1>ëŒ€í™”ë¬¸ ì™„ì„±í•˜ê¸° ì˜ë‹¨ì–´ í€´ì¦ˆê²Œì„</h1>

<div id="nameInputSection">
  <label for="userName">ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:</label>
  <input type="text" id="userName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
  <button id="toPreviewBtn">ì‹œì‘</button>
</div>

<div id="previewSection" style="display:none;">
  <h2>ì˜ˆìŠµ: ì „ì²´ ëŒ€í™”ë¬¸ê³¼ í•´ì„</h2>
  <div id="previewContainer"></div>
  <button id="startGameBtn">ê²Œì„ ì‹œì‘í•˜ê¸°</button>
</div>

<div id="quizSection" style="display:none;">
  <div id="progress"></div>
  <div id="sentence"></div>
  <div id="meaning"></div>
  <button id="submitBtn">ì œì¶œ</button>
  <button id="nextBtn" style="display:none;">ë‹¤ìŒ ë¬¸ì œ</button>
  <div id="feedback"></div>
</div>

<div id="resultSection" style="display:none;">
  <div id="scoreDisplay"></div>
  <button id="sendScoreBtn">ì ìˆ˜ ì„œë²„ ì „ì†¡</button>
  <div id="response"></div>
</div>

<script>
const game = "ë¹ˆì¹¸ í´ë¦­ ì…ë ¥í˜• ì˜ë‹¨ì–´ í€´ì¦ˆê²Œì„";

const paragraphs = [
  {
    eng:
`W: Excuse me, but you must not talk on the phone here.
B: Iâ€™m terribly sorry. Iâ€™ll turn off my phone.
W: You donâ€™t have to. Texting is OK.
B: I see. Thank you.`,
    kor:
`W: ì‹¤ë¡€í•©ë‹ˆë‹¤ë§Œ, ì—¬ê¸°ì„œ ì „í™”ê¸°ë¥¼ ì‚¬ìš©í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤.
B: ì •ë§ ì£„ì†¡í•©ë‹ˆë‹¤. ì „í™”ê¸°ë¥¼ ëŒê²Œìš”.
W: ê·¸ëŸ´ í•„ìš” ì—†ì–´ìš”. ë¬¸ìí•˜ëŠ” ê²ƒì€ ê´œì°®ì•„ìš”.
B: ì•Œê² ìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.`
  },
  {
    eng:
`G: Excuse me. May I touch this golden bear?
M: No, you may not. You must not touch anything in this room.
G: OK, I understand.`,
    kor:
`G: ì‹¤ë¡€í•©ë‹ˆë‹¤. ì´ ê¸ˆë¹› ê³°ì„ ë§Œì ¸ë„ ë˜ë‚˜ìš”?
M: ì•„ë‹ˆìš”, ì•ˆ ë©ë‹ˆë‹¤. ì´ ë°©ì—ì„œëŠ” ì–´ë–¤ ê²ƒë„ ë§Œì§€ë©´ ì•ˆ ë©ë‹ˆë‹¤.
G: ì•Œê² ìŠµë‹ˆë‹¤.`
  },
  {
    eng:
`B: May I go to the video room, Mom?
W: Of course, but donâ€™t run.
B: Why not?
W: Look at that sign. You must not run inside the museum.`,
    kor:
`B: ì—„ë§ˆ, ë¹„ë””ì˜¤ ë°©ì— ê°€ë„ ë ê¹Œìš”?
W: ë¬¼ë¡ ì´ì§€ë§Œ ë›°ë©´ ì•ˆ ë¼.
B: ì™œ ì•ˆ ë˜ì£ ?
W: ì € í‘œì§€íŒì„ ë´. ë°•ë¬¼ê´€ ì•ˆì—ì„œëŠ” ë›°ë©´ ì•ˆ ë¼.`
  },
  {
    eng:
`B: May I take food into the museum?
W: No, you may not. You must not bring any food inside.
B: How about water?
W: Only bottled water is OK.`,
    kor:
`B: ë°•ë¬¼ê´€ì— ìŒì‹ì„ ê°€ì ¸ê°€ë„ ë ê¹Œìš”?
W: ì•„ë‹ˆìš”, ì•ˆ ë©ë‹ˆë‹¤. ë°•ë¬¼ê´€ ì•ˆì— ìŒì‹ì„ ê°€ì ¸ê°€ë©´ ì•ˆ ë©ë‹ˆë‹¤.
B: ë¬¼ì€ ì–´ë•Œìš”?
W: ë³‘ì— ë“  ë¬¼ë§Œ ê´œì°®ì•„ìš”.`
  },
  {
    eng:
`M: Everybody, look over here, please. This is Sunflowers by Van Gogh.
G: Wow, this is my favorite painting. May I take a picture of it?
M: Yes, you may, but you must not use the flash.
G: Why not? Itâ€™s a little dark in here.
M: Iâ€™m sorry, but using the flash can damage paintings.
G: Oh, I didnâ€™t know that.
M: Everyone, weâ€™ll move on to Monetâ€™s paintings next.
G: Great!`,
    kor:
`M: ì—¬ëŸ¬ë¶„, ì´ë¦¬ ë´ ì£¼ì„¸ìš”. ì´ê²ƒì€ ë°˜ ê³ íì˜ í•´ë°”ë¼ê¸°ì…ë‹ˆë‹¤.
G: ì™€, ì´ê±° ì œê°€ ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ê·¸ë¦¼ì´ì—ìš”. ì‚¬ì§„ í•œì¥ ì°ì–´ë„ ë ê¹Œìš”?
M: ë„¤, ì°ìœ¼ì…”ë„ ë˜ì§€ë§Œ í”Œë˜ì‹œëŠ” ì‚¬ìš©í•˜ë©´ ì•ˆ ë¼ìš”.
G: ì™œ ì•ˆ ë˜ì£ ? ì—¬ê¸° ì¡°ê¸ˆ ì–´ë‘ì›Œìš”.
M: ì£„ì†¡í•˜ì§€ë§Œ í”Œë˜ì‹œëŠ” ê·¸ë¦¼ë“¤ì„ ì†ìƒì‹œí‚¬ ìˆ˜ ìˆì–´ìš”.
G: ì•„, ëª°ëì–´ìš”.
M: ì—¬ëŸ¬ë¶„, ë‹¤ìŒì€ ëª¨ë„¤ì˜ ê·¸ë¦¼ë“¤ë¡œ ë„˜ì–´ê°€ê² ìŠµë‹ˆë‹¤.
G: ì¢‹ì•„ìš”!`
  },
  {
    eng:
`A: May I ride a bike here?
B: Yes, you may.
A: May I fly a drone here?
B: No, you may not. You must not fly a drone here.`,
    kor:
`A: ì—¬ê¸°ì„œ ìì „ê±°ë¥¼ íƒ€ë„ ë˜ë‚˜ìš”?
B: ë„¤, ê·¸ë˜ë„ ë©ë‹ˆë‹¤.
A: ì—¬ê¸°ì„œ ë“œë¡ ì„ ë‚ ë ¤ë„ ë˜ë‚˜ìš”?
B: ì•„ë‹ˆìš”, ì•ˆ ë©ë‹ˆë‹¤. ì—¬ê¸°ì„œ ë“œë¡ ì„ ë‚ ë¦¬ë©´ ì•ˆ ë¼ìš”.`
  },
  {
    eng:
`A: Excuse me. May I bring my dog to the store?
B: No, you may not. You must not bring pets inside.
A: OK. I understand.`,
    kor:
`A: ì‹¤ë¡€í•©ë‹ˆë‹¤. ê°€ê²Œì— ë‚´ ê°•ì•„ì§€ë¥¼ ë°ë ¤ê°€ë„ ë ê¹Œìš”?
B: ì•„ë‹ˆìš”, ì•ˆ ë©ë‹ˆë‹¤. ì• ì™„ë™ë¬¼ì„ ê°€ê²Œ ì•ˆìœ¼ë¡œ ë°ë ¤ê°€ë©´ ì•ˆ ë¼ìš”.
A: ì•Œê² ìŠµë‹ˆë‹¤.`
  },
  {
    eng:
`B: May I eat here?
W: No, you may not eat inside the museum.
B: How about water? May I drink water?
W: Sure, water is OK.`,
    kor:
`B: ì—¬ê¸°ì„œ ë¨¹ì–´ë„ ë˜ë‚˜ìš”?
W: ì•„ë‹ˆìš”, ë°•ë¬¼ê´€ ì•ˆì—ì„œ ë¨¹ìœ¼ë©´ ì•ˆ ë©ë‹ˆë‹¤.
B: ë¬¼ì€ìš”? ë¬¼ì€ ë§ˆì…”ë„ ë˜ë‚˜ìš”?
W: ë¬¼ë¡ ì…ë‹ˆë‹¤, ë¬¼ì€ ê´œì°®ì•„ìš”.`
  },
];

const SETS = [
  {name:"ë‹¨ì–´ 20% ê°€ë¦¼", hideRatio:0.2},
  {name:"ë‹¨ì–´ 50% ê°€ë¦¼", hideRatio:0.5},
  {name:"ë‹¨ì–´ 70% ê°€ë¦¼", hideRatio:0.7},
];

let currentSetIndex = 0;
let currentQuizOrder = [];
let currentQuizIndex = 0;
let score = 0;
let startTime = 0;
let userName = "";

const nameInputSection = document.getElementById("nameInputSection");
const toPreviewBtn = document.getElementById("toPreviewBtn");
const previewSection = document.getElementById("previewSection");
const previewContainer = document.getElementById("previewContainer");
const startGameBtn = document.getElementById("startGameBtn");
const quizSection = document.getElementById("quizSection");
const sentenceEl = document.getElementById("sentence");
const meaningEl = document.getElementById("meaning");
const submitBtn = document.getElementById("submitBtn");
const nextBtn = document.getElementById("nextBtn");
const feedbackEl = document.getElementById("feedback");
const progressEl = document.getElementById("progress");
const resultSection = document.getElementById("resultSection");
const scoreDisplay = document.getElementById("scoreDisplay");
const sendScoreBtn = document.getElementById("sendScoreBtn");
const responseEl = document.getElementById("response");

let currentHiddenWords = [];
let currentInputs = [];

// ë‹¨ì–´ ëœë¤ ì…”í”Œ
function shuffleArray(array) {
  const arr = array.slice();
  for(let i=arr.length-1; i>0; i--) {
    const j = Math.floor(Math.random()*(i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

// ë¹ˆì¹¸(input) ìƒì„± ë° ë‹¨ì–´ ê°€ë¦¼, ëŒ€í™”ìëª… ì œì™¸
function makeBlankInputs(sentence, hideRatio) {
  // ì¤„ë³„ë¡œ ì²˜ë¦¬
  const lines = sentence.split("\n");
  let totalTokens = [];
  let hidePositions = [];
  let tokensByLine = [];

  // ì „ì²´ ë‹¨ì–´ ìœ„ì¹˜ ê¸°ì–µí•˜ë©´ì„œ ëŒ€í™”ìëª… ì œì™¸
  lines.forEach((line, lineIdx) => {
    const match = line.match(/^([A-Z]):\s*(.*)$/);
    let speaker = "";
    let content = "";
    if(match){
      speaker = match[1] + ":";
      content = match[2];
    } else {
      content = line;
    }
    const tokens = content.split(/(\s+|\b)/);
    tokensByLine.push({speaker, tokens});
    tokens.forEach((token, idx) => {
      if(/^[A-Za-z']+$/.test(token)){
        totalTokens.push({lineIdx, tokenIdx: idx});
      }
    });
  });

  const hideCount = Math.floor(totalTokens.length * hideRatio);
  const hideIndices = shuffleArray(totalTokens).slice(0, hideCount);

  let hideMap = {};
  hideIndices.forEach(({lineIdx, tokenIdx}) => {
    if(!hideMap[lineIdx]) hideMap[lineIdx] = new Set();
    hideMap[lineIdx].add(tokenIdx);
  });

  currentHiddenWords = [];
  currentInputs = [];

  const processedLines = tokensByLine.map(({speaker, tokens}, lineIdx) => {
    const newTokens = tokens.map((token, idx) => {
      if(hideMap[lineIdx] && hideMap[lineIdx].has(idx)) {
        currentHiddenWords.push(token);
        currentInputs.push(null);
        return `<input type="text" class="blankInput" data-idx="${currentHiddenWords.length-1}" maxlength="${token.length}" />`;
      }
      return token;
    });
    if(speaker) return `<div><strong>${speaker}</strong> ${newTokens.join('')}</div>`;
    else return `<div>${newTokens.join('')}</div>`;
  });

  return processedLines.join("\n");
}

function updateProgress() {
  progressEl.textContent = `ì„¸íŠ¸: ${SETS[currentSetIndex].name} / ë¬¸ì œ ${currentQuizIndex+1} / ì´ ${currentQuizOrder.length}ë¬¸ì œ`;
}

function showQuiz() {
  feedbackEl.textContent = "";
  submitBtn.disabled = false;
  nextBtn.style.display = "none";

  updateProgress();

  const idx = currentQuizOrder[currentQuizIndex];
  const paragraph = paragraphs[idx];
  const set = SETS[currentSetIndex];

  const sentenceHTML = makeBlankInputs(paragraph.eng, set.hideRatio);
  sentenceEl.innerHTML = sentenceHTML;
  meaningEl.textContent = `í•´ì„:\n${paragraph.kor}`;

  document.querySelectorAll(".blankInput").forEach(input => {
    input.addEventListener("input", e => {
      const i = parseInt(e.target.dataset.idx, 10);
      currentInputs[i] = e.target.value.trim();
      if(input.classList.contains("correct")) {
        input.disabled = true;
      }
    });
  });
}

function checkAnswer() {
  let isCorrect = true;
  let correctCount = 0;
  for(let i=0; i<currentHiddenWords.length; i++) {
    const userAns = (currentInputs[i] || "").toLowerCase().replace(/'/g,"");
    const correctAns = currentHiddenWords[i].toLowerCase().replace(/'/g,"");
    const inputEl = document.querySelector(`input.blankInput[data-idx="${i}"]`);
    const existingAnswerSpan = inputEl.nextSibling && inputEl.nextSibling.classList && inputEl.nextSibling.classList.contains("correctAnswer") ? inputEl.nextSibling : null;
    if(existingAnswerSpan) existingAnswerSpan.remove();

    if(userAns === correctAns) {
      inputEl.classList.add("correct");
      inputEl.classList.remove("incorrect");
      correctCount++;
      inputEl.disabled = true;
    } else {
      inputEl.classList.add("incorrect");
      inputEl.classList.remove("correct");
      isCorrect = false;
      inputEl.disabled = true;

      const answerSpan = document.createElement("span");
      answerSpan.className = "correctAnswer";
      answerSpan.textContent = correctAns;
      inputEl.after(answerSpan);
    }
  }

  if(isCorrect) {
    feedbackEl.style.color = "#2e7d32";
    feedbackEl.textContent = `ì •ë‹µ! ğŸ‰ +${correctCount * 10}ì `;
    score += correctCount * 10;
  } else {
    feedbackEl.style.color = "#d32f2f";
    feedbackEl.textContent = `í‹€ë¦° ë‹¨ì–´ê°€ ìˆìŠµë‹ˆë‹¤. í‹€ë¦° ì¹¸ ì˜†ì— ì •ë‹µì´ í‘œì‹œë©ë‹ˆë‹¤.`;
  }

  submitBtn.disabled = true;
  nextBtn.style.display = "inline-block";
}

function nextQuiz() {
  currentQuizIndex++;
  if(currentQuizIndex >= currentQuizOrder.length) {
    currentSetIndex++;
    if(currentSetIndex >= SETS.length) {
      showResult();
      return;
    } else {
      startSet();
      return;
    }
  }
  showQuiz();
}

function startSet() {
  currentQuizOrder = shuffleArray(paragraphs.map((_,i) => i));
  currentQuizIndex = 0;
  updateProgress();
  showQuiz();
}

function showResult() {
  quizSection.style.display = "none";
  resultSection.style.display = "block";
  const totalMaxScore = SETS.reduce((sum,set) => {
    return sum + paragraphs.reduce((acc,p)=>{
      const wordCount = p.eng.match(/\b[A-Za-z']+\b/g).length;
      return acc + Math.floor(wordCount * set.hideRatio) * 10;
    },0);
  },0);
  scoreDisplay.textContent = `${userName}ë‹˜ì˜ ì ìˆ˜: ${score}ì  / ìµœëŒ€ ì ìˆ˜ ì•½ ${totalMaxScore}ì `;
}

function generatePreview() {
  previewContainer.innerHTML = "";
  paragraphs.forEach(p => {
    const div = document.createElement("div");
    div.className = "paragraph";

    const engLines = p.eng.split("\n");
    const engHTML = engLines.map(line => {
      const match = line.match(/^([A-Z]):\s*(.*)$/);
      if(match){
        return `<div class="engLine"><span class="engSpeaker">${match[1]}:</span><span class="engText">${match[2]}</span></div>`;
      }
      return `<div class="engLine">${line}</div>`;
    }).join("");

    const korLines = p.kor.split("\n");
    const korHTML = korLines.map(line => `<div class="korLine">${line}</div>`).join("");

    div.innerHTML = `<div class="eng">${engHTML}</div><div class="kor">${korHTML}</div>`;
    previewContainer.appendChild(div);
  });
}

function saveData(game, name, score, elapsedTime) {
  const FUNCTION_URL = "https://us-central1-record-f420d.cloudfunctions.net/report";
  const requestData = {
    game,
    name,
    score: parseInt(score, 10),
    elapsedTime: parseInt(elapsedTime, 10)
  };
  fetch(FUNCTION_URL, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(requestData)
  }).then(async response => {
    const data = await response.json();
    if (response.ok) {
      responseEl.textContent = `ì„±ê³µ: ${JSON.stringify(data, null, 2)}`;
    } else {
      responseEl.textContent = `ì˜¤ë¥˜: ${JSON.stringify(data, null, 2)}`;
    }
  }).catch(error => {
    responseEl.textContent = `ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
  });
}

toPreviewBtn.addEventListener("click", () => {
  const nameVal = document.getElementById("userName").value.trim();
  if(nameVal === "") {
    alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
    return;
  }
  userName = nameVal;
  nameInputSection.style.display = "none";
  previewSection.style.display = "block";
  generatePreview();
});

startGameBtn.addEventListener("click", () => {
  previewSection.style.display = "none";
  quizSection.style.display = "block";
  score = 0;
  currentSetIndex = 0;
  startTime = Date.now();
  startSet();
});

submitBtn.addEventListener("click", () => {
  const allFilled = currentInputs.length > 0 && currentInputs.every(v => v && v.trim() !== "");
  if(!allFilled) {
    alert("ëª¨ë“  ë¹ˆì¹¸ì— ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
    return;
  }
  checkAnswer();
});

nextBtn.addEventListener("click", () => {
  nextQuiz();
});

sendScoreBtn.addEventListener("click", () => {
  const elapsedTime = (Date.now() - startTime) / 1000;
  saveData(game, userName, score, elapsedTime);
});
</script>

</body>
</html>
